/*! binary.min.js build:0.0.3, production. Copyright(c) 2012 Eric Zhang <eric@ericzhang.com> MIT Licensed */
(function(exports){
(function(e){function t(){this._events={}}function i(){t.call(this)}function s(e,t){i.call(this),t=r.extend({readDelay:0,paused:!1},t),this._source=e,this._start=0,this._readChunkSize=t.chunkSize||e.size,this._readDelay=t.readDelay,this.readable=!0,this.paused=t.paused,this._read()}function o(e,t,n,r){if(!(this instanceof o))return new o(options);var s=this;i.call(this),this.id=t,this._socket=e,this._socket.addEventListener("error",function(e){s.readable=!1,s.writable=!1,s.emit("error",e)}),this._socket.addEventListener("close",function(e,t){s.readable=!1,s.writable=!1,s.emit("close",e,t)}),this.writable=!0,this.readable=!0,this.paused=!1,this._ended=!1,n&&this._write(1,r,this.id)}function u(e,n){if(!(this instanceof u))return new u(n);t.call(this);var i=this;this._options=r.extend({chunkSize:40960},n),this._streams={},this._nextId=0,typeof e=="string"?this._socket=new WebSocket(e):this._socket=e,this._socket.binaryType="arraybuffer",this._socket.addEventListener("open",function(){i.emit("open")}),this._socket.addEventListener("error",function(e){i.emit("error",e)}),this._socket.addEventListener("close",function(e,t){i.emit("close",e,t)}),this._socket.addEventListener("message",function(e,t){r.setZeroTimeout(function(){e.hasOwnProperty("data")&&(e=e.data),e=r.unpack(e);switch(e[0]){case 0:break;case 1:var t=e[1],n=e[2],s=i._receiveStream(n);i.emit("stream",s,t);break;case 2:var o=e[1],n=e[2],s=i._streams[n];s?s._onData(o):i.emit("error","Received `data` message for unknown stream: "+n);break;case 3:var n=e[2],s=i._streams[n];s?s._onPause():i.emit("error","Received `pause` message for unknown stream: "+n);break;case 4:var n=e[2],s=i._streams[n];s?s._onResume():i.emit("error","Received `resume` message for unknown stream: "+n);break;case 5:var n=e[2],s=i._streams[n];s?s._onEnd():i.emit("error","Received `end` message for unknown stream: "+n);break;case 6:var n=e[2],s=i._streams[n];s?(s._onClose(),delete i._streams[n]):i.emit("error","Received `close` message for unknown stream: "+n);break;default:i.emit("error","Unrecognized message type received: "+e[0])}})})}var n=Array.isArray;t.prototype.addListener=function(e,t,r,i){if("function"!=typeof t)throw new Error("addListener only takes instances of Function");this.emit("newListener",e,typeof t.listener=="function"?t.listener:t),this._events[e]?n(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t},t.prototype.on=t.prototype.addListener,t.prototype.once=function(e,t,n){function i(){r.removeListener(e,i),t.apply(this,arguments)}if("function"!=typeof t)throw new Error(".once only takes instances of Function");var r=this;return i.listener=t,r.on(e,i),this},t.prototype.removeListener=function(e,t,r){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events[e])return this;var i=this._events[e];if(n(i)){var s=-1;for(var o=0,u=i.length;o<u;o++)if(i[o]===t||i[o].listener&&i[o].listener===t){s=o;break}if(s<0)return this;i.splice(s,1),i.length==0&&delete this._events[e]}else(i===t||i.listener&&i.listener===t)&&delete this._events[e];return this},t.prototype.off=t.prototype.removeListener,t.prototype.removeAllListeners=function(e){return arguments.length===0?(this._events={},this):(e&&this._events&&this._events[e]&&(this._events[e]=null),this)},t.prototype.listeners=function(e){return this._events[e]||(this._events[e]=[]),n(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]},t.prototype.emit=function(e){var e=arguments[0],t=this._events[e];if(!t)return!1;if(typeof t=="function"){switch(arguments.length){case 1:t.call(this);break;case 2:t.call(this,arguments[1]);break;case 3:t.call(this,arguments[1],arguments[2]);break;default:var r=arguments.length,i=new Array(r-1);for(var s=1;s<r;s++)i[s-1]=arguments[s];t.apply(this,i)}return!0}if(n(t)){var r=arguments.length,i=new Array(r-1);for(var s=1;s<r;s++)i[s-1]=arguments[s];var o=t.slice();for(var s=0,r=o.length;s<r;s++)o[s].apply(this,i);return!0}return!1};var r={inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},info:console.log.bind(console),pack:BinaryPack.pack,unpack:BinaryPack.unpack,setZeroTimeout:function(e){function r(r){t.push(r),e.postMessage(n,"*")}function i(r){r.source==e&&r.data==n&&(r.stopPropagation&&r.stopPropagation(),t.length&&t.shift()())}var t=[],n="zero-timeout-message";return e.addEventListener?e.addEventListener("message",i,!0):e.attachEvent&&e.attachEvent("onmessage",i),r}(this)};r.inherits(i,t),i.prototype.pipe=function(e,t){function r(t){e.writable&&!1===e.write(t)&&n.pause&&n.pause()}function i(){n.readable&&n.resume&&n.resume()}function o(){if(s)return;s=!0,e.end()}function u(){if(s)return;s=!0,e.destroy()}function a(e){f();if(this.listeners("error").length===0)throw e}function f(){n.removeListener("data",r),e.removeListener("drain",i),n.removeListener("end",o),n.removeListener("close",u),n.removeListener("error",a),e.removeListener("error",a),n.removeListener("end",f),n.removeListener("close",f),e.removeListener("end",f),e.removeListener("close",f)}var n=this;n.on("data",r),e.on("drain",i),!e._isStdio&&(!t||t.end!==!1)&&(n.on("end",o),n.on("close",u));var s=!1;return n.on("error",a),e.on("error",a),n.on("end",f),n.on("close",f),e.on("end",f),e.on("close",f),e.emit("pipe",n),e},r.inherits(s,i),s.prototype.pause=function(){this.paused=!0},s.prototype.resume=function(){this.paused=!1,this._read()},s.prototype.destroy=function(){this.readable=!1,clearTimeout(this._timeoutId)},s.prototype._read=function(){function t(){e._emitReadChunk()}var e=this,n=this._readDelay;n!==0?this._timeoutId=setTimeout(t,n):r.setZeroTimeout(t)},s.prototype._emitReadChunk=function(){if(this.paused||!this.readable)return;var e=Math.min(this._source.size-this._start,this._readChunkSize);if(e===0){this.readable=!1,this.emit("end");return}var t=this._start+e,n=(this._source.slice||this._source.webkitSlice||this._source.mozSlice).call(this._source,this._start,t);this._start=t,this._read(),this.emit("data",n)},e.BlobReadStream=s,r.inherits(o,i),o.prototype._onClose=function(){this.readable=!1,this.writable=!1,this.emit("close")},o.prototype._onPause=function(){this.emit("pause"),this.paused=!0},o.prototype._onResume=function(){this.emit("resume"),this.emit("drain"),this.paused=!1},o.prototype._write=function(e,t,n,i){var s=r.pack([e,t,n]);return this._socket.send(s,{binary:!0},i)!==!1},o.prototype.write=function(e,t){if(this.writable){var n=this._write(2,e,this.id,t);return!this.paused&&n}throw new Error("Stream is not writable")},o.prototype.end=function(){this._onEnd(),this._write(5,null,this.id)},o.prototype.destroy=o.prototype.destroySoon=function(){this._onClose(),this._write(6,null,this.id)},o.prototype._onEnd=function(){if(this._ended)return;this._ended=!0,this.readable=!1,this.emit("end")},o.prototype._onData=function(e){this.emit("data",e)},o.prototype.pause=function(){this._onPause(),this._write(3,null,this.id)},o.prototype.resume=function(){this._onResume(),this._write(4,null,this.id)},r.inherits(u,t),u.prototype.send=function(e,t){var n=this.createStream(t);if(e instanceof i)e.pipe(n);else if(r.isNode===!0)Buffer.isBuffer(e)?(new BufferReadStream(e,{chunkSize:this._options.chunkSize})).pipe(n):n.write(e);else if(r.isNode!==!0)if(e.constructor==Blob||e.constructor==File)(new s(e,{chunkSize:this._options.chunkSize})).pipe(n);else if(e.constructor==ArrayBuffer){var o;binaryFeatures.useArrayBufferView&&(e=new Uint8Array(e.buffer));if(binaryFeatures.useBlobBuilder){var u=new BlobBuilder;u.append(e),o=u.getBlob()}else o=new Blob([e]);(new s(o,{chunkSize:this._options.chunkSize})).pipe(n)}else if(typeof e=="object"&&"BYTES_PER_ELEMENT"in e){var o;binaryFeatures.useArrayBufferView||(e=e.buffer);if(binaryFeatures.useBlobBuilder){var u=new BlobBuilder;u.append(e),o=u.getBlob()}else o=new Blob([e]);(new s(o,{chunkSize:this._options.chunkSize})).pipe(n)}else n.write(e);return n},u.prototype._receiveStream=function(e){var t=new o(this._socket,e,!1);return this._streams[e]=t,t},u.prototype.createStream=function(e){var t=this._nextId;this._nextId+=2;var n=new o(this._socket,t,!0,e);return this._streams[t]=n,n},u.prototype.close=u.prototype.destroy=function(e,t){this._socket.close(e,t)},e.BinaryClient=u})(this)